<include file="public/head" />
<link href="APP_NAME/Public/css/dataTables.bootstrap.css" rel="stylesheet" />
<style type="text/css">
.addr_list a{ margin:5px 4px;}
</style>
</head>

<body>

    	<div class="page-header" style="top:46px;">
            <div class="header-title">
                <h4><i class="fa fa-home"></i> 首页 <small><i class="fa fa-angle-right"></i> 库存管理 </small></h4>
            </div>
        </div>
        <div class="page-body" style="margin-top:80px;">
            <div class="row">
                <div class="col-xs-12 col-md-12">
                	<div class="widget" id="list_stock" <if condition="$add eq 1">style="display:none;"</if> >
                        <div class="widget-header bordered-bottom bordered-blue">
                            <span class="widget-caption">库存列表</span>
                            <div class="widget-buttons"><a href="javascript:void(0)" class="btn btn-primary white" data-toggle="maximize" id="addstock_bt"><i class="fa fa-plus-square-o"></i> 添加库存</a></div>
                        </div>
                        <div class="widget-body no-padding" style="display: block;">
                            <div role="grid" id="searchable_wrapper" class="dataTables_wrapper form-inline">
                                <div class="well">
                                    <form name="form1" method="post" action="">
                                    <label>标题：<input type="search" class="form-control input-sm" aria-controls="searchable"></label>
                                    <label>编号：<input type="search" class="form-control input-sm" aria-controls="searchable"></label>
                                    <label><button type="submit" class="btn btn-primary"><i class="fa fa-search"></i> 搜索</button></label>
                                    </form>
                                </div>
                                <div class="dataTables_length" id="searchable_length">
                                    <label><select name="searchable_length" aria-controls="searchable" class="form-control input-sm"><option value="5">5</option><option value="15">15</option><option value="20">20</option><option value="-1">All</option></select>
                                    </label>
                                </div>

                                <table class="table table-bordered table-hover table-striped">
                                    <thead class="flip-content bordered-blue">
                                        <tr><th>名称</th><th>编号</th><th>图片</th><th>数量(单位)</th><th>时间</th><th>操作</th></tr>
                                    </thead>
                                    <tbody id="dataList"></tbody>
                                </table>
                                <div class="row DTTTFooter">
                                    <div class="dataTables_paginate paging_bootstrap" id="page">
                                        <ul class="pagination">
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
        			<div class="widget" <if condition="$add neq 1">style="display:none;"</if> id="add_stock">
                		<div class="widget-header radius-bordered">
                            <a href="javascript:void(0)" onclick="goback_send()"><i class="widget-icon fa fa-mail-reply blue"></i></a>
                            <span class="widget-caption">添加库存</span>
                        </div>
                        <div class="widget-body">
                        	<div class="widget-main ">
                                <div class="tabbable">
                                    <ul class="nav nav-tabs tabs-flat" id="myTab11">
                                        <li class="active"><a data-toggle="tab" href="#info-tab"> 基本信息</a></li>
                                        <li><a data-toggle="tab" href="#price-tab"> 售价管理</a></li>
                                        <li><a data-toggle="tab" href="#intro-tab"> 产品详情</a></li>
                                    </ul>
                                    <form role="form" id="form_data" class="form-horizontal">
                                    <div class="tab-content tabs-flat">
                                        <div id="info-tab" class="tab-pane in active">
                                            <div class="row">
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">产品名称：</label>
			                                            <div class="col-sm-8">
			                                                <input type="text" class="form-control" id="title" name="title" placeholder="">
			                                            </div>
			                                        </div>
			                                    </div>
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">简称：</label>
			                                            <div class="col-sm-8"> 
			                                                <input type="text" class="form-control" id="sub_stitle" name="sub_stitle" placeholder="">
			                                            </div>
			                                        </div>
			                                    </div>
		                                    </div>
		                                    <div class="row">
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">编号：</label>
			                                            <div class="col-sm-8">
			                                                <input type="text" class="form-control" id="shop_num" name="shop_num" placeholder="">
			                                            </div>
			                                        </div>
			                                    </div>
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">规格：</label>
			                                            <div class="col-sm-8"> 
			                                                <input type="text" class="form-control" id="shop_spec" name="shop_spec" placeholder="">
			                                            </div>
			                                        </div>
			                                    </div>
		                                    </div>
		                                    <div class="row">
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">重量：</label>
			                                            <div class="col-sm-8">
			                                                <div class="input-group">
			                                                	<input type="text" class="form-control" id="weight" name="weight" placeholder="">
                                                            	<span class="input-group-addon">千克</span>
                                                            </div>
			                                            </div>
			                                        </div>
			                                    </div>
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">单位：</label>
			                                            <div class="col-sm-8"> 
			                                                <select class="form-control" id="shop_unit" name="shop_unit">
			                                                	<option value="件">件</option><option value="箱">箱</option><option value="个">个</option><option value="瓶">瓶</option>
			                                                </select>
			                                            </div>
			                                        </div>
			                                    </div>
		                                    </div>
		                                    <div class="row">
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">型号：</label>
			                                            <div class="col-sm-8">
			                                                <input type="text" class="form-control" id="shop_model" name="shop_model" placeholder="">
			                                            </div>
			                                        </div>
			                                    </div>
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">数量：</label>
			                                            <div class="col-sm-8">
			                                                <input type="text" class="form-control" id="shop_count" name="shop_count" placeholder="">
			                                            </div>
			                                        </div>
			                                    </div>
		                                    </div>
		                                    <div class="row">
		                                    	<div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">发货方式：</label>
			                                            <div class="col-sm-8">
			                                                <select name="send_type" id="send_type" class="form-control">
			                                                	<option value="1">总店发货</option>
			                                                	<option value="2">厂家发货</option>
			                                                </select>
			                                            </div>
			                                        </div>
			                                    </div>
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">分类：</label>
			                                            <div class="col-sm-8">
			                                                <select name="categoryid" id="categoryid" class="form-control">
			                                                	<option value="">选择分类</option>
			                                                <foreach name="category" item="c">
			                                                	<option value="{$c.id}">{$c.title}</option>
			                                                </foreach>
			                                                </select>
			                                            </div>
			                                        </div>
			                                    </div>
		                                    </div>
		                                    <div class="row">
		                                    	<div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">产品图片：</label>
			                                            <div class="col-sm-8">
			                                                <img src="__IMG__nopic.jpg" class="noface display-inline-block vertical-align-bottom" style=" height:80px; width:auto;" id="showimg"/>
                											<div style="position:relative;width:50px;height:32px;overflow:hidden;display:inline-block;">
                  												<input type="file" id="upfile" name="upfile" style="opacity:0;filter:alpha(opacity=0);position:absolute; width: 200px;height:1000px;top:0;right:0;z-index:1;cursor:pointer;">&nbsp;
                  												<button type="button" class="btn btn-xs btn-primary display-inline-block vertical-align-bottom" style="position:absolute;top:0;right:0;">上传</button>
                  												<input type="hidden" name="picurl" id="picurl" value="">
                											</div>
			                                            </div>
			                                        </div>
			                                    </div>
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">产品类型：</label>
			                                            <div class="col-sm-8">
			                                                <select name="type" id="type" class="form-control">
			                                                	<option value="0">产品</option>
			                                                	<option value="1">赠品</option>
			                                                	<option value="2">残次</option>
			                                                </select>
			                                            </div>
			                                        </div>
			                                    </div>
		                                    </div>
                                        </div>
                                        <div id="price-tab" class="tab-pane">
                                            <div class="row">
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">成本价：</label>
			                                            <div class="col-sm-8">
			                                                <div class="input-group">
			                                                	<input type="text" class="form-control" id="costprice" name="costprice" placeholder="">
                                                            	<span class="input-group-addon">元</span>
                                                            </div>
			                                            </div>
			                                        </div>
			                                    </div>
			                                    <div class="col-lg-6 col-sm-6 col-xs-6">
			                                    	<div class="form-group">
			                                            <label class="col-sm-3 control-label no-padding-right">零售价：</label>
			                                            <div class="col-sm-8">
			                                                <div class="input-group">
			                                                	<input type="text" class="form-control" id="retailprice" name="retailprice" placeholder="">
                                                            	<span class="input-group-addon">元</span>
                                                            </div>
                                                        </div>
			                                        </div>
			                                    </div>
		                                    </div>
		                                    
                                        </div>
                                        <div id="intro-tab" class="tab-pane">
                                            <div id="summernote"></div>
                                        </div>
                                    </div>
                                    </form>
                                </div>
                            	<div class="row">
                                    <div class="form-group">
	                                    <label class="col-sm-2 control-label no-padding-right"></label>
	                                    <div class="col-sm-9">
	                                        <button type="submit" name="submit" id="submit" class="btn btn-primary mr10">确定</button><button type="button" name="button" class="btn btn-danger" onclick="goback_send()">取消</button>
	                                        <input type="hidden" id="stockid" name="stockid" />
	                                    </div>
	                                </div>
	                            </div>
                        	</div>
                        </div>
                	</div>
            	    
                </div>
        	</div>
    	</div>


<script src="APP_NAME/Public/js/beyond.min.js"></script>
<script src="APP_NAME/Public/js/summernote.js"></script>

<!--弹出窗口JS-->
<script src="APP_NAME/Public/js/bootbox.js"></script>
<script src="APP_NAME/Public/js/ajaxfileupload.js"></script>
<script>
$('#summernote').summernote({ height: 300 });

$(document).on('change','#upfile',function(){
	$.ajaxFileUpload({
		url:'{:U("Plugin/uploadpic")}',
		secureuri:false,
		fileElementId:'upfile',
		dataType:'json',
		type:'post',
		data: { fileElementId: 'upfile'},
		success:function(res){
			console.info(res);
			$('#showimg').attr('src','{$appname}'+res.thumb);
			$('#picurl').val(res.pic);
		},
		error:function(e){
			console.info(e);
		}　　　　　
	})	
})

$("#provinceid").change(function(){
	var parentId=$("#provinceid").get(0).selectedIndex*1+1;
	console.info(parentId);
	if(null!= parentId && ""!=parentId){		
		$.ajax({
			url:'{:U("Base/getCity")}',
			data:{'parentid':parentId},
			dataType:'json',
			success:function(res){
				console.info(res);
				var options="<option value=''>选择所在城市</option>";
				if(res.length>0){
					for(var i=0;i<res.length;i++){
						options+="<option value="+res[i].id+">"+res[i].name+"</option>";
					}
					$("#cityid").html(options);
				}
			}
		});
	}
	else{
		$("#cityid").html("");
	}
});


$("#submit").click(function(){
	var title = $("#title").val();
	var sub_title = $("#sub_title").val();
	var shop_num = $("#shop_num").val();
	var shop_unit = $("#shop_unit").val();
	var shop_spec = $("#shop_spec").val();
	var weight = $("#weight").val();
	var shop_model = $("#shop_model").val();
	var costprice = $("#costprice").val();
	//var saleprice = $("#saleprice").val();
	var retailprice = $("#retailprice").val();
	var remark = $('#summernote').code();
	var picurl = $("#picurl").val();
	var shop_count = $("#shop_count").val();
	var categoryid = $("#categoryid").val();
	var send_type = $("#send_type").val();
	var type = $("#type").val();

    var stockid = $("#stockid").val();
	
	console.info(remark);
	
	if(title == ""){
		alert("请输入产品标题"); return false;
	}

	$.ajax({
		url:'{:U("Product/operateStock")}',
		data:{'title':title,'sub_title':sub_title,'shop_num':shop_num,'shop_unit':shop_unit,'shop_spec':shop_spec,'weight':weight,'shop_model':shop_model,'costprice':costprice,'retailprice':retailprice,'picurl':picurl,'stockid':stockid,'shop_count':shop_count,'categoryid':categoryid,'send_type':send_type,'remark':remark},
		type:'post',
		dataType:'json',
		success:function(res){
			console.info(res);
            if(res.errcode == 0){
                if(stockid == ""){
                    goback_send();
                }else{
                    location.href = '{:U("Product/stock")}';
                }
            }else{
                alert(res.errmsg); return false;
            }
		}
	});
});

$(document).ready(function(e) {
	$('#addstock_bt').click(function(){
		
		$("#title").val("");			
		$("#sub_title").val("");
		$("#shop_unit").val("");
		$("#shop_num").val("");
		$("#shop_count").val("");
		$("#shop_spec").val("");
		$("#weight").val("");
		$("#shop_model").val("");
		$("#costprice").val("");
		//$("#saleprice").val("");
		$("#retailprice").val("");
		$("#picurl").val("");
		$("#stockid").val("");
		$('#summernote').code("");
		
        $('#list_stock').hide();
        $('#add_stock').slideDown('slow');
    });
    
    getList();
});

function goback_send(){
    $('#add_stock').hide();
    $('#list_stock').slideDown('slow');
}

$('#dataList').on('click','.edit',function(){
	var id = $(this).attr("data-id");
	
	$.ajax({
		url:'{:U("Product/getStockInfo")}',
		data:{"id":id},
		dataType:'json',
		success:function(res){
			console.info(res);
			$("#title").val(res.title);			
			$("#sub_title").val(res.sub_title);
			$("#shop_unit").val(res.shop_unit);
			$("#shop_num").val(res.shop_num);
			$("#shop_count").val(res.shop_count);
			$("#shop_spec").val(res.shop_spec);
			$("#weight").val(res.weight);
			$("#shop_model").val(res.shop_model);
			$("#costprice").val(res.costprice);
			//$("#saleprice").val(res.saleprice);
			$("#retailprice").val(res.retailprice);
			$("#picurl").val(res.picurl);
			$("#stockid").val(res.stockid);
			$('#summernote').code(res.remark);
			$('#categoryid').val(res.categoryid);
			$('#send_type').val(res.send_type);
			$('#type').val(res.type);
		}
	});
	
	$("#stockid").val(id);
	$('#list_stock').hide();
    $('#add_stock').slideDown('slow');
})

$('#dataList').on('click','.del',function(){
	var msg = "您真的确定要删除吗？\n\n请确认！"; 
	if (confirm(msg)==false)
	{ 
		return false; 
	}
	var id = $(this).attr('data-id');
	$('#result').html("数据处理中...");
	$.ajax({
        type: "POST",
        url: '{:U("Product/delStock")}',
		data:{"id":id},
		dataType: "json",
		success: function(res)
		{
			location.href = '{:U("Product/stock")}';
		}
			
	})
})

//加载列表数据
function getList(url,data){
	data = data || {};
	url = url || '{:U("Product/getStockList")}'; 
	
	$("#dataList").html("<tr><td colspan='6'>数据加载中......</td></tr>");
	
	$.get(url,data,function(rs){
		console.info(rs);
		if( rs.count>0){
			var html = '';
			$.each(rs.list,function(k,v){
				html += '<tr>';
				html += '<td>'+v.title+'</td>';
				html += '<td>'+v.shop_num+'</td>';
				html += '<td><img src='+v.picurl+' style="height:50px;width:auto;" /></td>';
				html += '<td>'+v.shop_count+'('+v.shop_unit+')</td>';
				html += '<td>'+v.createtime+'</td>';
				html += '<td>';
				html += '<a href="javascript:void(0)" data-id="'+v.id+'" class="edit"><i class="fa fa-edit text-primary"></i> 编辑</a>&nbsp;&nbsp;&nbsp;';
				html += '<a href="javascript:void(0)" data-id="'+v.id+'" class="del"><i class="fa fa-trash-o text-primary"></i> 删除</a>';
				html += '</td>';
				html += '</tr>';
			})
			$('#dataList').html(html);
			$('#page ul').html(rs.page);
		}else{
			$("#dataList").html("<tr><td colspan='6'>无查询结果</td></tr>");
			$('#page ul').empty();
		}
	})
}
</script>
</body>
</html>
